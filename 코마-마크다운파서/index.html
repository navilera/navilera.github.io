<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="This is Navilera&#39;s Blog">
    
    <link rel="shortcut icon" href="https://navilera.com/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.min.css">

    <link rel="canonical" href="https://navilera.com/%EC%BD%94%EB%A7%88-%EB%A7%88%ED%81%AC%EB%8B%A4%EC%9A%B4%ED%8C%8C%EC%84%9C/" />
    <title>코마 마크다운파서</title>
</head>
<body><header id="banner">
    <h2><a href="https://navilera.com">Navilera</a></h2>
    <nav>
        <ul>
            <li>
                <a href="/" title="posts">posts</a>
            </li><li>
                <a href="/about/" title="about">about</a>
            </li>
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>코마 마크다운파서</h1>
        <div>
                <time>June 19, 2022</time>
            </div>
    </header><h1 id="마크다운파서">마크다운파서</h1>
<p>나는 책 세 권을 썼다. 첫 번째 책은 2007년에서 2008년에 걸쳐 썼다. 당시에 나는 문서 작성은 당연히 워드 프로세서를 써야 하는줄 알았다. 그래서 아래아 한글로 책 한 권을 다 썼다. 두 번째 책은 2010년에서 2012년까지 약 2년 동안 썼다. 이 책도 워드 프로세서로 썼다. 그런데 아래아 한글을 쓰지 않고 오픈 오피스로 썼다. 세 번째 책은 2017년에서 2018년까지 썼다. 세 번째 책은 LaTeX로 썼다. 이 때 나는 워드 프로세서로 스타일 편집하는 것이 아니라 조판 도구로 문서 만드는 것이 더 편하다는 것을 알았다. 그 후로 LaTeX의 복잡함 대신 마크다운을 이용해서 글을 쓴다. 만약 내가 네 번째 책을 쓴다면 아마 마크다운으로 책을 쓸 것 같다.</p>
<p>내 글은 거의 대부분 소스 코드가 있고 그 코드를 설명하는 내용으로 된 글이 많다. 내 책 세 권은 모두 그런 스타일이고 주로 쓰는 글도 그렇다. 소스 코드와 함께 글을 쓸 때마다 매번 고민하는 것이 있다. 소스 코드를 줄 단위로 인용해서 설명을 하는 가장 효율적인 방법은 무엇일까 하는 것이다. 현재까지 내가 찾은 방법은 소스 코드에 줄 번호를 달고 줄번호를 이용해서 인용하는 것이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="nf">putstr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Hal_uart_put_char</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>예를 들어, 위와 같은 코드를 인용한다면 아래와 같이 각 라인에 줄 번호를 붙이는 것이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">uint32_t</span> <span class="n">putstr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>        <span class="n">Hal_uart_put_char</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="n">c</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">|</span>        <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>이렇게 줄 번호를 붙이면 번호를 이용해 코드를 설명할 수 있다. 참고로 위 코드는 내가 개발한 RTOS인 나빌로스 소스 코드에서 가져왔다. 04번째 줄 부터 08번째 줄 까지의 코드를 다시 인용한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>        <span class="n">Hal_uart_put_char</span><span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="n">c</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>        <span class="p">}</span>
</span></span></code></pre></div><p>그러면 위와 같이 코드 조각을 따로 인용하고 해당 코드를 조각 조각 나눠 설명하는 식이다. 나는 이런식으로 글 쓰는 것을 좋아한다. 인용한 코드에는 원본의 줄번호가 그대로 나와서 원본에서 어느 부분의 코드인지 찾아보기 쉽도록 의도했다.</p>
<p>첫 책을 쓸 때는 출판사에서 원고 코드에 줄번호를 달아서 편집본을 내게 줬다. 그 편집본을 받아서 본문에 몇 번째 줄, 몇 번째 줄을 일일이 수작업으로 달았다. 두 번째 책은 소스 코드가 많지 않아서 별로 어렵지 않았고, 세 번째 책은 LaTeX의 플러그인으로 처리했다. 하지만 완전히 동작하진 않아서 수작업이 필요했다.</p>
<p>마크다운 자체는 그저 스타일링을 아주 단순한 문법으로 표현하는 포멧 규칙일 뿐 위에서 말한 줄번호 넣기라든지 줄번호 참조 같은 기능 따위는 없다. 그래서 마크다운 일부를 읽어서 줄번호를 넣어주고 해당 줄번호를 참조해서 변환하는 파서겸 변환기를 만들었다.</p>
<h2 id="방법을-고민">방법을 고민</h2>
<p>해당 목적을 달성하기 위해 내가 활용할 수 있는 방법은 많다. 가장 단순하고 빠르게 구현할 수 있는 방법은 그냥 python으로 줄 단위로 변경하는 것이다.</p>
<p>예를 들어, 아래 같은 마크다운을 정의한다.</p>
<pre tabindex="0"><code>    --&gt;
      어떤 코드;
      어떤 코드;
      어떤 코드;
      어떤 코드;
    &lt;--
</code></pre><p>마크다운 문법에 &lsquo;&ndash;&gt;&lsquo;로 시작하고 &lsquo;&lt;&ndash;&lsquo;로 끝나는 태그는 없다. 내가 임의로 정한 태그다. 해당 블록안에 있는 코드에 자동으로 줄번호를 다는 컨버터를 만드는 것이다. python으로 아래 코드 정도로 간단히 만들 수 있다.</p>
<p>[Code 01-01]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="mi">01</span><span class="o">|</span>    <span class="k">def</span> <span class="nf">conv_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">il</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="mi">02</span><span class="o">|</span>        <span class="k">if</span> <span class="n">il</span> <span class="o">==</span> <span class="s2">&#34;--&gt;</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="ow">or</span> <span class="n">il</span> <span class="o">==</span> <span class="s2">&#34;&lt;--</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">03</span><span class="o">|</span>            <span class="k">if</span> <span class="n">il</span> <span class="o">==</span> <span class="s2">&#34;&lt;--</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">04</span><span class="o">|</span>            <span class="bp">self</span><span class="o">.</span><span class="n">code_line_number</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="mi">05</span><span class="o">|</span>            <span class="k">return</span> <span class="s2">&#34;```</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="mi">06</span><span class="o">|</span>        <span class="n">ln_il</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_line_number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;    &#34;</span> <span class="o">+</span> <span class="n">il</span>
</span></span><span class="line"><span class="cl"><span class="mi">07</span><span class="o">|</span>        <span class="bp">self</span><span class="o">.</span><span class="n">code_line_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>        <span class="k">return</span> <span class="n">ln_il</span>
</span></span></code></pre></div><p>코드 [01-01]은 내가 실제로 사용했던 코드 중 일부다. 파라매터 il은 원본 원고 마크다운 문서를 한 줄 씩 읽어서 전달한 것이다. 02번째 줄에서 시작 태그와 끝 태그를 찾고 04번째 줄은 시작 태그일 때 줄 번호를 초기화한다. 그리고 06번째 줄에서 줄번호를 맨 앞에 붙이고 적당한 공백을 넣고 원본 내용을 넣어서 문자열을 새로 만든다. 이러면 원본 마크다운 소스코드에 줄 번호가 들어가게 된다.</p>
<p>이렇게 방향을 잡고 프로그램을 만들기 시작하면 초기에는 결과를 빨리 볼 수 있어 좋다. 그러나 언제나 그렇듯 요구 사항은 늘어난다. (혼자 만들고 혼자 쓰는 프로그램임에도!!!!) 요구 사항이 늘어나고 복잡해 질 수록 코드를 유지 보수하기 어려워진다. 가장 큰 문제는 이런 코드는 어떤 식으로든 반드시 스파게티 코드가 되어 버린다는 것이다.</p>
<p>그럼에도 만약 이 작업이 회사에서 하는 일이고 빠른 결과가 나와야 하는 일이라면 나는 이렇게 그냥 파이썬으로 빠르게 작업하고 말았을 것이다. 하지만 지금 이 작업은 그냥 내가 취미로 하는 일이다. 취미로 하는 일이기 때문에 뭔가 조금 더 그럴듯하고 조금 더 시간이 걸려도 된다.</p>
<p>그럼 조금 더 복잡하게 줄 단위로 읽어서 정규 표현식을 적용하여 필요한 변경 요소를 찾는 것이다. 나쁘지 않은 방법이다. 그런데 이왕 이렇게 할 바엔 차라리 파서까지 만들어 볼까하는 생각이 든다.</p>
<p>파서를 만들어서 처리하면 내가 변환하고 싶어하는 부분에 속성(attribute)을 부여할 수 있다. 그러면 코드 자체가 다소 복잡해 지더라도 코드의 구조를 파악하기가 더 쉽다. 어찌 됐든 속성을 부여한 파서 코드에서 부터 시작해서 필요한 부분을 찾아볼 수 있기 때문이다.</p>
<h2 id="필요한-부분만-파싱하는-파서-정의">필요한 부분만 파싱하는 파서 정의</h2>
<p>작성할 글에는 코드 블록이 두 종류 필요하다. 하나는 마크다운 코드 블록 그 자체다. 이 코드 블록은 내가 건들지 않는다. 두 번째는 줄번호를 자동으로 넣어야 하는 코드 블록이다. 그래서 마크다운 태그와 충돌하지 않는 새로운 코드블록 태그를 새로 정의한다. 나는 %%%를 줄번호 생성용 코드 블록 태그로 정의했다.</p>
<pre tabindex="0"><code>    ```
    코드1
    코드2
    코드3
    ```
</code></pre><p>위 코드는 마크다운 코드 블록 그대로다. 그래서 아무 작업하지 않고 그대로 아래처럼 출력한다.</p>
<pre tabindex="0"><code>    코드1
    코드2
    코드3
</code></pre><p>줄번호를 자동으로 생성하는 코드 블록은 아래와 같다.</p>
<pre tabindex="0"><code>    %%%
    코드1
    코드2
    코드3
    %%%
</code></pre><p>이렇게 %%%로 시작과 끝을 태깅하고 코드를 넣으면 아래처럼 변환된다.</p>
<pre tabindex="0"><code>01|    코드1
02|    코드2
03|    코드3
</code></pre><p>위 코드는 변환기로 자동 변환한 결과다. 계속 변환기라고 부르기엔 정이 안가므로 이쯤해서 이름을 지어야겠다. 이름은 코마(COMA)다. COnfiguable MArkdown processor라고 풀 네임을 짓긴했는데 그냥 이름 짓다가 혼수상태 빠질것 같아서 코마로 지었다. 앞으로 코마라고 부르겠다.</p>
<h1 id="코마">코마</h1>
<p>사실 이 글을 쓰는 목적은 코마를 테스트하기 위함이다. 이글은 코마로 변환해서 최종적으로 블로그에 게시할 것이다.</p>
<h2 id="기능-설명">기능 설명</h2>
<p>내가 계속 글을 쓰고 그것을 코마로 변환하는한 아마 기능은 계속 추가될 것이다. 현 시점에서 코마에 넣은 기능은 아래와 같다.</p>
<ul>
<li>코드 블록에 자동으로 줄 번호 넣어줌</li>
<li>줄 번호를 본문 설명에 자동으로 넣어줌</li>
<li>인용을 재인용 하는 코드에 해당 코드의 줄 번호를 그대로 인용함</li>
<li>코드 블록에 번호를 매겨줌</li>
<li>코드 블록 번호를 본문 설명에서 인용함</li>
</ul>
<p>아직도 코마에 버그가 남아 있어서 디버깅 중이라, 윗 내용까지 쓰고 지금 이 줄을 쓰는데 일주일이 넘게 걸렸다. 계속 이어서 글을 쓰겠다.</p>
<h2 id="문법">문법</h2>
<p>문법은 지금도 변경 중이다. 이 글을 쓰고 있는 현시점에서의 문법을 설명한다.</p>
<p>[Code 02-01]</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="nl">doc</span> <span class="p">:</span> <span class="n">para</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>        <span class="o">|</span> <span class="n">para</span> <span class="n">doc</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="o">|</span> <span class="n">code</span> <span class="n">doc</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>    <span class="nl">para</span> <span class="p">:</span> <span class="n">TITLE</span>                <span class="p">{</span> <span class="n">write_header</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>         <span class="o">|</span> <span class="n">CODE_LINE</span>             <span class="p">{</span> <span class="n">write_md_text</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>         <span class="o">|</span> <span class="n">CODE_NUM</span>                 <span class="p">{</span> <span class="n">write_code_num</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">|</span>         <span class="o">|</span> <span class="n">LABELED_CODE_LINE</span>     <span class="p">{</span> <span class="n">write_replace_code_line</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">|</span>        <span class="o">|</span> <span class="n">MD_CODE_QUOTE</span>         <span class="p">{</span> <span class="n">write_quote</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span><span class="o">|</span>         <span class="o">|</span> <span class="n">QUOTE_BLOCK</span>              <span class="p">{</span> <span class="n">write_plain</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span><span class="o">|</span>         <span class="o">|</span> <span class="n">bullet_list</span> <span class="n">NEW_LINE</span>     <span class="p">{</span> <span class="n">write_plain</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span><span class="o">|</span>         <span class="o">|</span> <span class="n">sentence_list</span> <span class="n">NEW_LINE</span>    <span class="p">{</span> <span class="n">write_text</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">|</span>         <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">15</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">16</span><span class="o">|</span>    <span class="nl">code</span> <span class="p">:</span> <span class="n">CODE_QUOTE</span> <span class="n">codeblock</span> <span class="n">CODE_QUOTE</span>         <span class="p">{</span> <span class="n">write_code</span><span class="p">(</span><span class="err">$</span><span class="mi">2</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">|</span>         <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">18</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">19</span><span class="o">|</span>    <span class="nl">codeblock</span> <span class="p">:</span> <span class="n">codeline</span>
</span></span><span class="line"><span class="cl"><span class="mi">20</span><span class="o">|</span>          <span class="o">|</span> <span class="n">codeline</span> <span class="n">codeblock</span>               
</span></span><span class="line"><span class="cl"><span class="mi">21</span><span class="o">|</span>          <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">22</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">23</span><span class="o">|</span>    <span class="nl">codeline</span> <span class="p">:</span> <span class="n">CODE_LINE</span>                         
</span></span><span class="line"><span class="cl"><span class="mi">24</span><span class="o">|</span>         <span class="o">|</span> <span class="n">LABELED_CODE_LINE</span>                 
</span></span><span class="line"><span class="cl"><span class="mi">25</span><span class="o">|</span>         <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">26</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">27</span><span class="o">|</span>    <span class="nl">bullet_list</span> <span class="p">:</span> <span class="n">BULLET_LIST</span>
</span></span><span class="line"><span class="cl"><span class="mi">28</span><span class="o">|</span>            <span class="o">|</span> <span class="n">BULLET_LIST</span> <span class="n">bullet_list</span>
</span></span><span class="line"><span class="cl"><span class="mi">29</span><span class="o">|</span>            <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">30</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">31</span><span class="o">|</span>    <span class="nl">sentence_list</span> <span class="p">:</span>                              <span class="p">{</span> <span class="err">$$</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">32</span><span class="o">|</span>              <span class="o">|</span> <span class="n">sentence</span>                 
</span></span><span class="line"><span class="cl"><span class="mi">33</span><span class="o">|</span>              <span class="o">|</span> <span class="n">sentence</span> <span class="n">SPACE</span> <span class="n">sentence_list</span>
</span></span><span class="line"><span class="cl"><span class="mi">34</span><span class="o">|</span>              <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">35</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">36</span><span class="o">|</span>    <span class="nl">sentence</span> <span class="p">:</span> <span class="n">WORD_DOT</span>
</span></span><span class="line"><span class="cl"><span class="mi">37</span><span class="o">|</span>         <span class="o">|</span> <span class="n">REF_LINE</span> <span class="n">SPACE</span> <span class="n">sentence</span>
</span></span><span class="line"><span class="cl"><span class="mi">38</span><span class="o">|</span>         <span class="o">|</span> <span class="n">REF_CODE</span> <span class="n">sentence</span>
</span></span><span class="line"><span class="cl"><span class="mi">39</span><span class="o">|</span>         <span class="o">|</span> <span class="n">WORD</span> <span class="n">sentence</span>
</span></span><span class="line"><span class="cl"><span class="mi">40</span><span class="o">|</span>         <span class="p">;</span>
</span></span></code></pre></div><p>위 코드 [02-01]가 현 시점 코마의 전체 문법이다. 먼저 시작 문법인 doc을 보자. 01번째 줄부터 04번째 줄까지 코드다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="nl">doc</span> <span class="p">:</span> <span class="n">para</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>        <span class="o">|</span> <span class="n">para</span> <span class="n">doc</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="o">|</span> <span class="n">code</span> <span class="n">doc</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="p">;</span>
</span></span></code></pre></div><p>doc은 문서(document)다. para는 문단(paragraph)다. 즉, 문서는 문단이 한 개 이상 반복되거나 문단과 코드(code)가 섞여서 반복됨을 정의했다. 문단과 코드에 해당하는 문법 정의 두 개로만 이뤄졌다.</p>
<p>먼저 문단의 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>    <span class="nl">para</span> <span class="p">:</span> <span class="n">TITLE</span>            <span class="p">{</span> <span class="n">write_header</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>         <span class="o">|</span> <span class="n">CODE_LINE</span>         <span class="p">{</span> <span class="n">write_md_text</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>         <span class="o">|</span> <span class="n">CODE_NUM</span>                 <span class="p">{</span> <span class="n">write_code_num</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">|</span>         <span class="o">|</span> <span class="n">LABELED_CODE_LINE</span>     <span class="p">{</span> <span class="n">write_replace_code_line</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">|</span>         <span class="o">|</span> <span class="n">MD_CODE_QUOTE</span>          <span class="p">{</span> <span class="n">write_quote</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span><span class="o">|</span>         <span class="o">|</span> <span class="n">QUOTE_BLOCK</span>              <span class="p">{</span> <span class="n">write_plain</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span><span class="o">|</span>         <span class="o">|</span> <span class="n">bullet_list</span> <span class="n">NEW_LINE</span>     <span class="p">{</span> <span class="n">write_plain</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span><span class="o">|</span>         <span class="o">|</span> <span class="n">sentence_list</span> <span class="n">NEW_LINE</span>    <span class="p">{</span> <span class="n">write_text</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">|</span>         <span class="p">;</span>
</span></span></code></pre></div><p>사실상 내가 재정의한 코드 블록을 제외한 모든 마크다운 문법이 모두 문단(para)이다. 문단은 다음 요소로 이뤄져 있다.</p>
<ul>
<li>제목 (TITLE)</li>
<li>코드 (CODE_LINE)</li>
<li>코드 블록 번호 (CODE_NUM)</li>
<li>줄번호가 달린 코드 (LABELED_CODE_LINE)</li>
<li>오리지널 마크다운의 코드 블록 태그 (MD_CODE_QUOTE)</li>
<li>인용 (QUOTE_BLOCK)</li>
<li>리스트 (bullet_list)</li>
<li>텍스트 문단 (sentence_list)</li>
</ul>
<p>각 요소는 lexer에서 정규표현식으로 구분한다.</p>
<p>제목은 마크다운 문법에서 #으로 시작하는 그 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="s">&#34;#&#34;</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="p">.</span><span class="o">+</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TITLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>첫 글자가 #이고 #이 한 개 이상 반복되다가 공백이 나오고 아무 문자나 나오다가 개행으로 끝나는 한 줄은 제목으로 판단한다. 익숙한 마크다운의 그것이다.</p>
<p>코드는 문서에서 소스 코드를 한 줄씩 표현하는 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="err">\</span><span class="n">t</span><span class="p">.</span><span class="o">*</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CODE_LINE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>탭 문자로 시작하고 아무글자나 나오다가 개행으로 끝나는 한 줄은 코드로 판단한다. 마크다운 문법에서는 코드 블록 태그로 감싸기만 하면 코드로 인식하긴 하지만 코마에서 조금 더 쉬운 파싱을 위해 코드는 무조건 탭으로 한 번 들여쓰기를 하게 했다. 그리고 마크다운 문법에서도 코드 블록 태그를 쓰지 않고 그냥 탭으로 한 번 들여쓰기를 하면 코드로 인식한다. 나는 둘을 섞어 쓰는 것을 강제하여 코마가 코드로 인식하게 했다.</p>
<p>코드 블록 번호는 문서에서 인용하는 소스 코드의 이름이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="s">&#34;code{&#34;</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="s">&#34;}&#34;</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CODE_NUM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>흔히 소스 코드를 설명하는 문서에서 코드를 지칭할 때 &lsquo;코드 10-15&rsquo; 이렇게 인용한 소스 코드에 번호를 매겨서 설명한다. 이를 위한 문법이다. 이 문법은 마크다운에는 없고 코마 전용 문법이다. 소스 코드 시작 부분에 쓰면 코마에서 자동으로 소스 코드에 번호를 매긴다. 본문에서 aaa에 해당하는 레퍼런스 레이블을 사용하면 자동으로 코드 번호로 변환한다.</p>
<p>애초에 코마를 만들기로 결심한 이유가 인용한 소스 코드에 줄 번호를 자동으로 넣고 싶어서 였다. 그리고 본문에서 줄 번호 인용을 쉽게 하기 위함이었다. 그 용도로 만든 문법이 줄 번호가 달린 코드 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">][</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z</span><span class="p">]</span><span class="s">&#34;|&#34;</span><span class="err">\</span><span class="n">t</span><span class="p">.</span><span class="o">*</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">LABELED_CODE_LINE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>기본 문법은 소스 코드 한 줄과 같다. 다만 시작 문자가 탭이 아니라 알파벳 두 글자 이고 구분자가 나온 다음 탭 문자가 나오고 소스 코드가 한 줄 나오면 줄 번호가 다른 코드 문법으로 인식하고 알파벳 두 글자를 레퍼런스 이름으로 해서 본문에서 인용한다.</p>
<p>오리지널 마크다운의 코드 블록 태그는 그냥 원래 마크다운의 코드 시작 태그다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="s">&#34;```</span><span class="se">\n</span><span class="s">&#34;</span>        <span class="k">return</span> <span class="n">MD_CODE_QUOTE</span><span class="p">;</span>
</span></span></code></pre></div><p>인용도 원래 마크다운의 인용 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="s">&#34;&gt; &#34;</span><span class="p">.</span><span class="o">+</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">QUOTE_BLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>리스트도 원래 마크다운에서 리스트를 표현하는 문법이다. 코드 [02-01]에서 27번째 줄부터 29번째 줄 코드를 다시 인용한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mi">27</span><span class="o">|</span>    <span class="nl">bullet_list</span> <span class="p">:</span> <span class="n">BULLET_LIST</span>
</span></span><span class="line"><span class="cl"><span class="mi">28</span><span class="o">|</span>            <span class="o">|</span> <span class="n">BULLET_LIST</span> <span class="n">bullet_list</span>
</span></span><span class="line"><span class="cl"><span class="mi">29</span><span class="o">|</span>            <span class="p">;</span>
</span></span></code></pre></div><p>BULLET_LIST 토큰이 연속되는 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="o">^</span><span class="s">&#34;*&#34;</span><span class="o">+</span><span class="s">&#34; &#34;</span><span class="p">.</span><span class="o">+</span><span class="err">\</span><span class="n">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">BULLET_LIST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>토큰 자체는 그냥 마크다운의 문법 그대로다.</p>
<p>텍스트 문단은 문서의 대부분을 차지하는 본문 설명이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mi">31</span><span class="o">|</span>    <span class="nl">sentence_list</span> <span class="p">:</span>                              <span class="p">{</span> <span class="err">$$</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">32</span><span class="o">|</span>              <span class="o">|</span> <span class="n">sentence</span>                 
</span></span><span class="line"><span class="cl"><span class="mi">33</span><span class="o">|</span>              <span class="o">|</span> <span class="n">sentence</span> <span class="n">SPACE</span> <span class="n">sentence_list</span>
</span></span><span class="line"><span class="cl"><span class="mi">34</span><span class="o">|</span>              <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">35</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">36</span><span class="o">|</span>    <span class="nl">sentence</span> <span class="p">:</span> <span class="n">WORD_DOT</span>
</span></span><span class="line"><span class="cl"><span class="mi">37</span><span class="o">|</span>         <span class="o">|</span> <span class="n">REF_LINE</span> <span class="n">SPACE</span> <span class="n">sentence</span>
</span></span><span class="line"><span class="cl"><span class="mi">38</span><span class="o">|</span>         <span class="o">|</span> <span class="n">REF_CODE</span> <span class="n">sentence</span>
</span></span><span class="line"><span class="cl"><span class="mi">39</span><span class="o">|</span>         <span class="o">|</span> <span class="n">WORD</span> <span class="n">sentence</span>
</span></span><span class="line"><span class="cl"><span class="mi">40</span><span class="o">|</span>         <span class="p">;</span>
</span></span></code></pre></div><p>텍스트 문단은 문장(sentence)의 연속으로 구성되 있다. 문장은 단어(WORD)의 연속 혹은 코드 인용(REF_CODE) 혹은 줄 번호 인용(REF_LINE)의 연속이다. 그리고 문장은 마침표를 찍은 문장(WORD_DOT)으로 반드시 끝나야 한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z가</span><span class="o">-</span><span class="err">힣</span><span class="p">,</span><span class="err">\</span><span class="o">&lt;</span><span class="err">\</span><span class="o">&gt;</span><span class="err">\</span><span class="p">(</span><span class="err">\</span><span class="p">)</span><span class="err">\</span><span class="p">[</span><span class="err">\</span><span class="p">]</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="err">\</span><span class="o">|</span><span class="err">\</span><span class="o">!</span><span class="err">\&#39;\</span><span class="s">&#34;\%\#_]+&#34;</span> <span class="s">&#34; {</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">WORD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">zA</span><span class="o">-</span><span class="n">Z가</span><span class="o">-</span><span class="err">힣</span><span class="p">,</span><span class="err">\</span><span class="o">&lt;</span><span class="err">\</span><span class="o">&gt;</span><span class="err">\</span><span class="p">(</span><span class="err">\</span><span class="p">)</span><span class="err">\</span><span class="p">[</span><span class="err">\</span><span class="p">]</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="err">\</span><span class="o">|</span><span class="err">\</span><span class="o">!</span><span class="err">\&#39;\</span><span class="s">&#34;\%\#_]+[\.\?] {</span>
</span></span><span class="line"><span class="cl">    <span class="n">yylval</span><span class="p">.</span><span class="n">str</span> <span class="o">=</span> <span class="n">yytext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">WORD_DOT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>WORD는 단어가 나오고 뒤에 공백(띄어쓰기)가 나오는 토큰이고, WORD_DOT은 단어가 나오고 마침표가 나오는 토큰이다. 단어의 정규표현식은 한글을 포함하고 여러 특수 문자를 표기했다. 글을 쓰면서 필요한 특수 문자는 그때 그때 lex 정의 파일에 추가하고 있다.</p>
<p>다음은 코드 문법이다. 코드의 시작과 끝을 표시하는 태그(CODE_QUOTE)로 감싸여 있는 codeblock 문법이다. codeblock 문법은 다시 codeline이 반복되는 문법이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mi">16</span><span class="o">|</span>    <span class="nl">code</span> <span class="p">:</span> <span class="n">CODE_QUOTE</span> <span class="n">codeblock</span> <span class="n">CODE_QUOTE</span>         <span class="p">{</span> <span class="n">write_code</span><span class="p">(</span><span class="err">$</span><span class="mi">2</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">|</span>         <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">18</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">19</span><span class="o">|</span>    <span class="nl">codeblock</span> <span class="p">:</span> <span class="n">codeline</span>
</span></span><span class="line"><span class="cl"><span class="mi">20</span><span class="o">|</span>          <span class="o">|</span> <span class="n">codeline</span> <span class="n">codeblock</span>               
</span></span><span class="line"><span class="cl"><span class="mi">21</span><span class="o">|</span>          <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">22</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">23</span><span class="o">|</span>    <span class="nl">codeline</span> <span class="p">:</span> <span class="n">CODE_LINE</span>                         
</span></span><span class="line"><span class="cl"><span class="mi">24</span><span class="o">|</span>         <span class="o">|</span> <span class="n">LABELED_CODE_LINE</span>                 
</span></span><span class="line"><span class="cl"><span class="mi">25</span><span class="o">|</span>         <span class="p">;</span>
</span></span></code></pre></div><p>코드 한 줄(codeline)이 어떻게 파싱되는지만 알면 된다. CODE_LINE과 LABELED_CODE_LINE는 위에서 설명했다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">void</span> <span class="n">write_header</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>            <span class="n">s_chapter_num</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>            <span class="n">s_code_num_of_chap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>제목을 생성하는 코드다. 실질적으로 하는 일은 07번째 줄에 있는 fprintf() 함수로 원본 내용을 그대로 쓰는 것 뿐이다. 바로위에 03번째 줄부터 06번째 줄에 조건문은 챕터마다 s_chapter_num 변수 값을 하나씩 올린다. 소스 코드 번호를 챕터마다 하나씩 올리기 위해서 카운트하는 변수다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">void</span> <span class="n">write_text</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>텍스트를 생성하는 코드다. 딱히 하는 일은 없고 그냥 입력을 그대로 출력에 보낸다. 마지막에 개행을 넣어준다. lex, yacc로 파싱 및 문법 처리 과정에서 개행이 사라진다. 그래서 이렇게 개행을 넣어줘야 원본과 같아진다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">void</span> <span class="n">write_code_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="k">if</span> <span class="p">(</span><span class="n">s_printing_line_num</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;%02d|%s&#34;</span><span class="p">,</span> <span class="n">s_printing_line_num</span><span class="o">++</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>    
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>코드 한 줄은 줄 번호를 표시하는 코드와 줄 번호를 표시하지 않는 코드. 이렇게 두 종류가 있다. s_printing_line_num 전역 변수로 구분한다. s_printing_line_num 전역 변수에 0이 아닌 값이 있을 때는 줄 번호를 표시하라는 뜻이다. 그래서 s_printing_line_num를 검사해서 줄 번호 표시 여부를 판단 한 다음 줄 번호를 표시하거나 그냥 출력한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">void</span> <span class="n">write_replace_code_line</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="n">SET_LINE_REF_KEY</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="k">if</span> <span class="p">(</span><span class="n">s_recording_code_line</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>            <span class="n">add_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">s_printing_line_num</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;%02d|%s&#34;</span><span class="p">,</span> <span class="n">s_printing_line_num</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>            <span class="kt">uint32_t</span> <span class="n">line_num</span> <span class="o">=</span> <span class="n">get_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">|</span>            <span class="k">if</span> <span class="p">(</span><span class="n">line_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">|</span>                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Line indicater is not found! -- key: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span><span class="o">|</span>                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span><span class="o">|</span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span><span class="o">|</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;%02d|%s&#34;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">|</span>            <span class="c1">// if s_printing_line_num is not zero means that second position so, reset to zero
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">15</span><span class="o">|</span>            <span class="c1">// if s_printing_line_num is zero means that first position so, set the starting line number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">16</span><span class="o">|</span>            <span class="n">s_printing_line_num</span> <span class="o">=</span> <span class="n">s_printing_line_num</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">line_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">18</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>소스 코드를 부분 인용하거나 최초 인용하는 소스 코드에 레퍼런스 레이블이 붙어 있을 경우에 대한 처리를 하는 함수다. 최초 인용일 때는 04번째 줄에서 레퍼런스 레이블과 해당 레이블이 있는 줄 번호를 key value storage에 저장한다. 소스 코드를 부분 인용 할 때는 줄 번호를 그대로 가져와야 한다. 그래서 08번째 줄에서 레퍼런스 레이블을 key로 하여 줄 번호를 key value storage에서 가져 온 다음 그 줄 번호를 출력한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">void</span> <span class="n">write_code_num</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ref</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="n">s_code_num_of_chap</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="n">SET_CODE_REF_KEY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_chapter_num</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="n">s_code_num_of_chap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>        <span class="n">add_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="n">fprintf</span><span class="p">(</span><span class="n">out_fp</span><span class="p">,</span> <span class="s">&#34;[Code %02d-%02d]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s_chapter_num</span><span class="p">,</span> <span class="n">s_code_num_of_chap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>코드 번호를 생성하는 함수다. key value storage는 값으로 int 타입 값만 가질 수 있으므로 챕터 번호-코드 번호 형태로 된 값을 수용할 수 없다. 그래서 챕터 번호를 100 이상 숫자에 배정하고 코드 번호를 99 이하 숫자에 배정해서 출력할 때 변환한다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="kt">uint32_t</span> <span class="n">get_linenum</span><span class="p">(</span><span class="kt">char</span> <span class="n">k1</span><span class="p">,</span> <span class="kt">char</span> <span class="n">k2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">k1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>        <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">line_num</span> <span class="o">=</span> <span class="n">get_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="k">return</span> <span class="n">line_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">|</span>    <span class="kt">uint32_t</span> <span class="n">get_codenum</span><span class="p">(</span><span class="kt">char</span> <span class="n">k1</span><span class="p">,</span> <span class="kt">char</span> <span class="n">k2</span><span class="p">,</span> <span class="kt">char</span> <span class="n">k3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span><span class="o">|</span>        <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span><span class="o">|</span>        <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">k1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">|</span>        <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">15</span><span class="o">|</span>        <span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">k3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">16</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">line_num</span> <span class="o">=</span> <span class="n">get_key_value</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">18</span><span class="o">|</span>        <span class="k">return</span> <span class="n">line_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">19</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>줄 번호를 받아 오는 함수와 코드 번호를 받아 오는 함수는 기본적으로 동일하다. key value storage에서 값을 받아서 그대로 리턴할 뿐이다. 줄 번호는 키가 두 글자고 코드 번호는 키가 세 글자다. 내가 정한 규칙이다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mo">01</span><span class="o">|</span>    <span class="k">static</span> <span class="kt">void</span> <span class="n">add_key_value</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mo">02</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">03</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">key_index</span> <span class="o">=</span> <span class="n">search_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">04</span><span class="o">|</span>        <span class="k">if</span> <span class="p">(</span><span class="n">s_key_value</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mo">05</span><span class="o">|</span>            <span class="n">s_key_value</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mo">06</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mo">07</span><span class="o">|</span>        <span class="n">s_key_value</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">08</span><span class="o">|</span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">09</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">10</span><span class="o">|</span>    <span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">get_key_value</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">11</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">12</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">key_index</span> <span class="o">=</span> <span class="n">search_key</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">13</span><span class="o">|</span>        <span class="k">return</span> <span class="n">s_key_value</span><span class="p">[</span><span class="n">key_index</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">14</span><span class="o">|</span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">15</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">16</span><span class="o">|</span>    <span class="k">static</span> <span class="kt">uint32_t</span> <span class="n">search_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">17</span><span class="o">|</span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">18</span><span class="o">|</span>        <span class="c1">// Just linear search
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">19</span><span class="o">|</span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s_key_value_end</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">20</span><span class="o">|</span>        <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">21</span><span class="o">|</span>            <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">s_key_value</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">22</span><span class="o">|</span>                <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">23</span><span class="o">|</span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">24</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">25</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">26</span><span class="o">|</span>        <span class="kt">uint32_t</span> <span class="n">not_found_index</span> <span class="o">=</span> <span class="n">s_key_value_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">27</span><span class="o">|</span>        <span class="n">s_key_value_end</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">28</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">29</span><span class="o">|</span>        <span class="k">if</span> <span class="p">(</span><span class="n">s_key_value_end</span> <span class="o">&gt;=</span> <span class="n">KV_MAX</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="mi">30</span><span class="o">|</span>            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Exceed key value size</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">31</span><span class="o">|</span>            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="mi">32</span><span class="o">|</span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mi">33</span><span class="o">|</span>    
</span></span><span class="line"><span class="cl"><span class="mi">34</span><span class="o">|</span>        <span class="k">return</span> <span class="n">not_found_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="mi">35</span><span class="o">|</span>    <span class="p">}</span>
</span></span></code></pre></div><p>key value storage 관련 함수들이다. key value storage에 값을 추가하고 받아오고 검색하는 함수다. 아주 간단하게 구현한 key value storage다. 복잡하게 구현할 필요가 없기 때문이다.</p>
<p>코마는 현재 이 문서를 내가 의도한 대로 잘 변환한다. 어느 정도 목적을 달성하고 쓸만한 툴이라고 판단한다. 이제 쓰던 책을 다시 쓰러 가야 겠다.</p>
</article>

        </main><footer id="footer">
    Copyright © 2022 Navilera
</footer>
</body>
</html>
